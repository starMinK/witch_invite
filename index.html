<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>마녀들의 초대 효율 계산기</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,"Noto Sans KR",Arial;margin:10px;background:#fafafa;color:#111;display:flex;flex-direction:row;gap:24px;flex-wrap:wrap;justify-content:center}
h1{font-size:22px;margin-bottom:10px;text-align:center}
.container{display:flex;flex-wrap:wrap;gap:24px;justify-content:center}
.left{max-width:100%;display:flex;flex-direction:column;align-items:center}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 14px rgba(20,20,20,0.06);width:100%;max-width:320px}
.cell{aspect-ratio:1/1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;transition:background 0.2s}
.cell.off{background:#f3f3f3;color:#888}
.cell.on{background:#2b8aef;color:white}
.controls{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
button,select{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:white;cursor:pointer;font-size:14px}
.info{margin-top:12px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 4px 14px rgba(20,20,20,0.04);font-size:14px;width:100%;max-width:320px;text-align:center}
.placement{font-family:monospace;word-break:break-all}
.right{max-width:380px;line-height:1.6;background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.05);flex:1 1 320px}
.right h2{font-size:18px;margin-top:0;text-align:center}
@media (max-width:600px){
  body {
    flex-direction: column;
    align-items: center;
    margin: 8px;
  }
  .container {
    flex-direction: column;
    align-items: center;
    width: 100%;
    gap: 16px;
  }
  .left, .right {
    max-width: 95%;
    width: 100%;
    text-align: center;
    flex: none;
  }
  .grid {
    max-width: 100%;
    width: 100%;
  }
  .right {
    font-size: 14px;
    padding: 12px;
    box-sizing: border-box;
  }
  .controls {
    justify-content: center;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="left">
    <h1>마녀들의 초대 효율 계산기 2.0</h1>
    <div id="grid" class="grid"></div>
    <div class="controls">
    <div>
      <label>패턴: <select id="pattern-select"></select></label>
      </div>
      <div>
      <button id="recommend">추천 배치 표시</button>
      <button id="apply">적용</button>
      <button id="random-flip">랜덤 패턴 자동 적용</button>
      </div>
      <div>
      <button id="clear">초기화</button>
      <button id="undo">뒤로 되돌리기</button>
      </div>
    </div>
    <div class="info">
      <div>추천 배치: <span id="placement" class="placement">(none)</span></div>
      <div>채워진 칸: <strong id="fill">0%</strong></div>
    </div>
  </div>

  <div class="right">
    <h2>v2.0</h2>
    <p><strong>가장 적고 손해 없이</strong> 빙고 채우기</p>
    <p>교주에게 뜬 패턴을 입력하고 <strong>추천 배치 표시</strong> 클릭. 추천 배치를 누르면 가장 효율적인 위치가 표시됨.</p>
    <p>이후에 적용 클릭</p>
    <p><strong>자동 실행:</strong> 대충 어떻게 돌아가는지 보고 싶으면 눌러보셈 (확률 적용 x)</p>
    <p>확률 계산 로직 궁금한 볼붕이들을 위해 링크 남김</p>
    <p><a href="https://github.com/starMinK/witch_invite/blob/main/README.md">링크</a></p>
  </div>
</div>

<script>
const N = 7;
const PATTERNS = {
  '×': [[0,0],[-1,-1],[-1,1],[1,-1],[1,1]],
  '✚': [[0,0],[-1,0],[1,0],[0,-1],[0,1]],
  '■': [[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]],
  'ㅡ': Array.from({length:7},(_,i)=>[0,i]),
  'ㅣ': Array.from({length:7},(_,i)=>[i,0])
};

let board = new Array(N*N).fill(0);
let highlight = null;
let history = [];

function getCookie(name){const v=document.cookie.match('(^|;) ?'+name+'=([^;]*)(;|$)');return v?decodeURIComponent(v[2]):null;}
function setCookie(name,value,days=7){const exp=new Date(Date.now()+days*864e5).toUTCString();document.cookie=`${name}=${encodeURIComponent(value)}; expires=${exp}; path=/`}

const saved = getCookie('boardState7x7');
if(saved){ try { board = JSON.parse(saved); } catch(e){ console.warn('쿠키 파싱 실패'); } }

function idx(r,c){return r*N+c;}
function saveHistory(){history.push(board.slice()); if(history.length>20) history.shift();}
function applyPlacement(b,coords){const nb=b.slice(); coords.forEach(([r,c])=>nb[idx(r,c)]=1); return nb;}
function fillRate(b){return b.reduce((a,v)=>a+v,0)/(N*N);}
function effectiveFill(b,coords){return coords.filter(([r,c])=>b[idx(r,c)]===0).length;}

function computePlacements(){
  const placements = {};
  for(const name in PATTERNS){
    const offs = PATTERNS[name];
    placements[name] = [];
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const coords = offs.map(([dr,dc])=>[r+dr,c+dc]);
        if(coords.every(([r,c])=>r>=0&&r<N&&c>=0&&c<N)) placements[name].push(coords);
      }
    }
  }
  return placements;
}
const PLACEMENTS = computePlacements();

function greedyPlacementOptimized(board, pattern){
  let best=null, bestEff=-1;
  for(const coords of PLACEMENTS[pattern]){
    const eff = effectiveFill(board, coords);
    if(eff>bestEff){bestEff=eff; best=coords;}
  }
  return best;
}

const gridEl = document.getElementById('grid');
const patternSelect = document.getElementById('pattern-select');

function renderGrid(){
  gridEl.innerHTML='';
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const i = idx(r,c), val = board[i];
      const el = document.createElement('div');
      el.className = 'cell ' + (val ? 'on' : 'off');
      if(highlight?.some(([hr,hc])=>hr===r && hc===c)) el.style.boxShadow='0 0 0 3px rgba(43,138,239,0.18)';
      el.textContent = val ? '●' : '';
      gridEl.appendChild(el);
    }
  }
}

function updateStatus(){
  document.getElementById('fill').textContent=(fillRate(board)*100).toFixed(1)+'%';
}

// --- 옵션 생성 ---
for(const p in PATTERNS){
  const o=document.createElement('option'); o.value=p; o.textContent=p;
  patternSelect.appendChild(o);
}

// --- 버튼 이벤트 ---
document.getElementById('recommend').onclick = () => {
  const selected = patternSelect.value;
  if(!selected){ alert('패턴 선택 필요'); return; }
  const coords = greedyPlacementOptimized(board, selected);
  highlight = coords;
  document.getElementById('placement').textContent = coords ? coords.map(([r,c])=>`(${r},${c})`).join(' ') : '(none)';
  renderGrid();
};

document.getElementById('apply').onclick = () => {
  if(!highlight){ alert('먼저 추천 배치를 표시하세요.'); return; }
  saveHistory();
  board = applyPlacement(board, highlight);
  highlight = null;
  setCookie('boardState7x7', JSON.stringify(board));
  renderGrid(); updateStatus();
};

document.getElementById('clear').onclick = () => {
  saveHistory();
  board = new Array(N*N).fill(0);
  highlight = null;
  setCookie('boardState7x7', JSON.stringify(board));
  renderGrid(); updateStatus();
  document.getElementById('placement').textContent='(none)';
};

document.getElementById('undo').onclick = () => {
  if(history.length===0){ alert('더 이상 되돌릴 수 없습니다'); return; }
  board = history.pop();
  highlight = null;
  setCookie('boardState7x7', JSON.stringify(board));
  renderGrid(); updateStatus();
};

let autoRunning = false;
document.getElementById('random-flip').onclick = () => {
  if(autoRunning){ autoRunning=false; document.getElementById('random-flip').textContent='랜덤 패턴 자동 적용'; return; }
  autoRunning=true; document.getElementById('random-flip').textContent='중지';
  (async function(){
    const names = Object.keys(PATTERNS);
    while(autoRunning && fillRate(board)<1.0){
      const p = names[Math.floor(Math.random()*names.length)];
      const coords = greedyPlacementOptimized(board,p);
      highlight = coords; renderGrid();
      await new Promise(r=>setTimeout(r,350));
      if(coords){ saveHistory(); board = applyPlacement(board,coords); }
      setCookie('boardState7x7', JSON.stringify(board));
      updateStatus();
      await new Promise(r=>setTimeout(r,220));
    }
    autoRunning=false;
    document.getElementById('random-flip').textContent='랜덤 패턴 자동 적용';
  })();
};

// 초기 실행
renderGrid(); updateStatus();
</script>
</body>
</html>
